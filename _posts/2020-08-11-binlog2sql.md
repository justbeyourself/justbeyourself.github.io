---
layout: post
title: mysql闪回
date: 2020-08-11
tags: [语言]
comments: true
toc: false
---

> 引用 [binlog2sql](https://github.com/danfengcao/binlog2sql)

# binlog2sql

从 MySQL binlog 解析出你要的 SQL。根据不同选项，你可以得到原始 SQL、回滚 SQL、去除主键 the INSERT SQL 等。

## 用途

- 数据快速回滚 (闪回)
- 主从切换后新 master 丢数据的修复
- 从 binlog 生成标准 SQL，带来的衍生功能

## 环境

- **已测试环境**
    - Python 2.7, 3.4+
    - MySQL 5.6, 5.7
    - *注：MySQL 8.0 PyMySQL==0.9.3 必须是这个版本*

## 安装

```bash
git clone https://github.com/danfengcao/binlog2sql.git && cd binlog2sql
pip install -r requirements.txt
```
*git 与 pip 的安装问题请自行搜索解决。*

## 使用

### MySQL Server 必须设置以下参数

```ini
[mysqld]
server_id = 1
log_bin = /var/log/mysql/mysql-bin.log
max_binlog_size = 1G
binlog_format = row
binlog_row_image = full
```

### User 需要的最小权限集合

```sql
-- 最小权限：select, super/replication client, replication slave
-- 建议授权
GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'user'@'host';
```

**权限说明**

- `select`：需要读取 server 端 `information_schema.COLUMNS` 表，获取表结构的元信息，拼接成可视化的 SQL 语句。
- `super/replication client`：两个权限都可以，需要执行 `SHOW MASTER STATUS`，获取 server 端的 binlog 列表。
- `replication slave`：通过 `BINLOG_DUMP` 协议获取 binlog 内容的权限。

### 基本用法

**解析出标准 SQL**

```bash
python binlog2sql.py -h127.0.0.1 -P3306 -uadmin -p'admin' -dtest -t test3 test4 --start-file='mysql-bin.000002'

# 输出：
# INSERT INTO `test`.`test3`(`addtime`, `data`, `id`) VALUES ('2016-12-10 13:03:38', 'english', 4);
# UPDATE `test`.`test3` SET `addtime`='2016-12-10 12:00:00', `data`='中文', `id`=3 WHERE `addtime`='2016-12-10 13:03:22' AND `data`='中文' AND `id`=3 LIMIT 1;
# DELETE FROM `test`.`test3` WHERE `addtime`='2016-12-10 13:03:38' AND `data`='english' AND `id`=4 LIMIT 1;
```

**解析出回滚 SQL**

```bash
python binlog2sql.py --flashback -h127.0.0.1 -P3306 -uadmin -p'admin' -dtest -ttest3 --start-file='mysql-bin.000002' --start-position=763 --stop-position=1147

# 输出：
# INSERT INTO `test`.`test3`(`addtime`, `data`, `id`) VALUES ('2016-12-10 13:03:38', 'english', 4);
# UPDATE `test`.`test3` SET `addtime`='2016-12-10 13:03:22', `data`='中文', `id`=3 WHERE `addtime`='2016-12-10 12:00:00' AND `data`='中文' AND `id`=3 LIMIT 1;
```

## 选项说明

### MySQL 连接配置
`-h host; -P port; -u user; -p password`

### 解析模式
- `--stop-never`：持续解析 binlog。
- `-K, --no-primary-key`：对 INSERT 语句去除主键。
- `-B, --flashback`：生成回滚 SQL。
- `--back-interval`：`-B` 模式下，每打印一千行回滚 SQL，加一句 SLEEP 多少秒。

### 解析范围控制
- `--start-file`：起始解析文件。
- `--start-position/--start-pos`：起始解析位置。
- `--stop-file/--end-file`：终止解析文件。
- `--stop-position/--end-pos`：终止解析位置。
- `--start-datetime`：起始解析时间。
- `--stop-datetime`：终止解析时间。

### 对象过滤
- `-d, --databases`：只解析目标 db 的 SQL。
- `-t, --tables`：只解析目标 table 的 SQL。
- `--only-dml`：只解析 DML，忽略 DDL。
- `--sql-type`：只解析指定类型 (INSERT, UPDATE, DELETE)。

## 应用案例

### 误删整张表数据，需要紧急回滚

**1. 模拟误操作**
```sql
-- test 库 tbl 表原有数据
mysql> select * from tbl;
+----+--------+---------------------+
| id | name   | addtime             |
+----+--------+---------------------+
|  1 | 小赵   | 2016-12-10 00:04:33 |
|  2 | 小钱   | 2016-12-10 00:04:48 |
|  3 | 小孙   | 2016-12-13 20:25:00 |
|  4 | 小李   | 2016-12-12 00:00:00 |
+----+--------+---------------------+

-- 误操作清空表
mysql> delete from tbl;
Query OK, 4 rows affected (0.00 sec)
```

**2. 查看当前 binlog**
```sql
mysql> show master status;
+---------------+----------+
| File          | Position |
+---------------+----------+
| binlog.000023 |  1036958 |
+---------------+----------+
```

**3. 定位误操作 SQL 的位置**
```bash
python binlog2sql/binlog2sql.py -h127.0.0.1 -P3306 -uadmin -p'admin' -dtest -ttbl --start-file='mysql-bin.000052' --start-datetime='2016-12-13 20:25:00' --stop-datetime='2016-12-13 20:30:00'
```

**4. 生成回滚 SQL**
```bash
python binlog2sql/binlog2sql.py -h127.0.0.1 -P3306 -uadmin -p'admin' -dtest -ttbl --start-file='mysql-bin.000052' --start-position=3346 --stop-position=3556 -B > rollback.sql
```

**5. 执行回滚并确认**
```bash
mysql -h127.0.0.1 -P3306 -uadmin -p'admin' < rollback.sql

mysql> select * from tbl;
```

